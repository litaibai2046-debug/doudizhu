<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>æ–—åœ°ä¸»ï¼ˆç®€åŒ–å¯ç© Web ç‰ˆï¼‰</title>
  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;margin:0;background:#0f172a;color:#e5e7eb}
    header{padding:16px 20px;border-bottom:1px solid #334155;display:flex;gap:12px;align-items:center}
    header h1{font-size:16px;margin:0;color:#fff}
    header .tag{font-size:12px;padding:4px 8px;border:1px solid #334155;border-radius:999px;color:#cbd5e1}
    main{padding:14px;max-width:1100px;margin:0 auto}
    .card{background:#111827;border:1px solid #334155;border-radius:14px;padding:14px}
    .pile{min-height:54px;border:1px dashed #334155;border-radius:14px;padding:10px;display:flex;gap:8px;flex-wrap:wrap}
    .playingCard{user-select:none;display:inline-flex;align-items:center;justify-content:center;min-width:44px;height:54px;padding:0 10px;background:#0b1220;border:1px solid #334155;border-radius:12px;cursor:pointer;font-weight:600}
    .playingCard.selected{outline:2px solid #22c55e;border-color:#22c55e}
    .btn{border:1px solid #334155;background:#0b1220;color:#fff;padding:10px 12px;border-radius:12px;cursor:pointer}
    .btn.primary{background:#2563eb;border-color:#2563eb}
    .btn.danger{background:#dc2626;border-color:#dc2626}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:space-between}
    .muted{color:#94a3b8;font-size:12px}
    .log{margin-top:10px;height:260px;overflow:auto;white-space:pre-wrap;background:#0b1220;border:1px solid #334155;border-radius:14px;padding:10px;font-size:12px}
  </style>
</head>
<body>
<header>
  <h1>æ–—åœ°ä¸»ï¼ˆç®€åŒ–å¯ç© Web ç‰ˆï¼‰</h1>
  <span class="tag">ä½  vs 2 AI</span>
  <span class="tag">æ”¯æŒï¼šå•/å¯¹/ä¸‰/ä¸‰å¸¦ä¸€/ä¸‰å¸¦äºŒ</span>
</header>

<main>
  <div class="card">
    <div class="row">
      <div class="muted" id="status">å›åˆï¼š-ï½œä¸Šä¸€æ‰‹ï¼šæ— </div>
      <div class="row" style="justify-content:flex-end">
        <button class="btn primary" id="newBtn">æ–°å¼€ä¸€å±€</button>
        <button class="btn" id="passBtn">è¿‡ç‰Œ</button>
        <button class="btn danger" id="playBtn">å‡ºç‰Œ</button>
      </div>
    </div>

    <div style="margin-top:10px" class="muted">ç‰Œæ¡Œ</div>
    <div class="pile" id="tablePile"></div>

    <div style="margin-top:10px" class="muted">ä½ çš„æ‰‹ç‰Œï¼ˆç‚¹å‡»é€‰ä¸­ï¼‰</div>
    <div class="pile" id="myPile"></div>

    <div class="log" id="log"></div>
  </div>
</main>

<script>
(() => {
  const RANKS = ['3','4','5','6','7','8','9','10','J','Q','K','A','2','SJ','BJ'];
  const V = Object.fromEntries(RANKS.map((r,i)=>[r,i]));

  const $ = (id)=>document.getElementById(id);
  const myPile = $("myPile"), tablePile = $("tablePile"), logEl = $("log"), status = $("status");
  const newBtn = $("newBtn"), passBtn = $("passBtn"), playBtn = $("playBtn");

  let hands = [[],[],[]]; // 0 you
  let selected = new Set(); // indices
  let turn = 0; // 0 you 1 ai1 2 ai2
  let last = null; // {type,cards,main}
  let lastPlayer = null;

  function log(s){ logEl.textContent += s + "\n"; logEl.scrollTop = logEl.scrollHeight; }
  function sort(h){ h.sort((a,b)=>V[a]-V[b]); return h; }

  function deck(){
    const d=[];
    for (const r of RANKS.slice(0,-2)) for(let i=0;i<4;i++) d.push(r);
    d.push('SJ','BJ');
    for(let i=d.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [d[i],d[j]]=[d[j],d[i]]; }
    return d;
  }

  function classify(cards){
    if(!cards.length) return null;
    const c={}; cards.forEach(r=>c[r]=(c[r]||0)+1);
    const keys=Object.keys(c), counts=Object.values(c).sort((a,b)=>b-a).join(',');
    if(cards.length===1) return {type:"single",cards:[...cards],main:cards[0]};
    if(cards.length===2 && keys.length===1) return {type:"pair",cards:[...cards],main:keys[0]};
    if(cards.length===3 && keys.length===1) return {type:"triple",cards:[...cards],main:keys[0]};
    if(cards.length===4 && counts==="3,1") return {type:"triple_single",cards:[...cards],main:keys.find(k=>c[k]===3)};
    if(cards.length===5 && counts==="3,2") return {type:"triple_pair",cards:[...cards],main:keys.find(k=>c[k]===3)};
    return null;
  }
  function beats(a,b){ if(!b) return true; if(a.type!==b.type) return false; return V[a.main]>V[b.main]; }
  function remove(hand,cards){ cards.forEach(r=>hand.splice(hand.indexOf(r),1)); }

  function aiPlay(hand,last){
    sort(hand);
    const cnt={}; hand.forEach(r=>cnt[r]=(cnt[r]||0)+1);
    const ranks=Object.keys(cnt).sort((a,b)=>V[a]-V[b]);
    const plays=[];
    ranks.forEach(r=>plays.push({type:"single",cards:[r],main:r}));
    ranks.forEach(r=>cnt[r]>=2 && plays.push({type:"pair",cards:[r,r],main:r}));
    ranks.forEach(r=>cnt[r]>=3 && plays.push({type:"triple",cards:[r,r,r],main:r}));
    ranks.forEach(r=>{
      if(cnt[r]>=3){
        const s=ranks.find(x=>x!==r && cnt[x]>=1);
        if(s) plays.push({type:"triple_single",cards:[r,r,r,s],main:r});
      }
    });
    ranks.forEach(r=>{
      if(cnt[r]>=3){
        const p=ranks.find(x=>x!==r && cnt[x]>=2);
        if(p) plays.push({type:"triple_pair",cards:[r,r,r,p,p],main:r});
      }
    });

    if(!last){
      const order={triple_pair:0,triple_single:1,triple:2,pair:3,single:4};
      plays.sort((x,y)=>(order[x.type]-order[y.type])||(V[x.main]-V[y.main]));
      return plays[0]||null;
    }
    const same=plays.filter(p=>p.type===last.type && beats(p,last));
    same.sort((x,y)=>V[x.main]-V[y.main]);
    return same[0]||null;
  }

  function render(){
    // status
    const tn = turn===0?"ä½ (åœ°ä¸»)":turn===1?"AI-1":"AI-2";
    const ls = last ? `${last.type} ${last.cards.join(' ')}(ä¸»:${last.main})` : "æ— ";
    status.textContent = `å›åˆï¼š${tn}ï½œä¸Šä¸€æ‰‹ï¼š${ls}`;
    passBtn.disabled = (turn!==0) || (last===null);
    playBtn.disabled = (turn!==0);

    // table
    tablePile.innerHTML="";
    (last?.cards||[]).forEach(r=>{
      const el=document.createElement("div"); el.className="playingCard"; el.textContent=r; el.style.cursor="default";
      tablePile.appendChild(el);
    });

    // my hand
    myPile.innerHTML="";
    sort(hands[0]);
    hands[0].forEach((r,idx)=>{
      const el=document.createElement("div");
      el.className="playingCard"+(selected.has(idx)?" selected":"");
      el.textContent=r;
      el.onclick=()=>{ if(turn!==0) return; selected.has(idx)?selected.delete(idx):selected.add(idx); render(); };
      myPile.appendChild(el);
    });
  }

  function resetIfNeeded(next){
    if(lastPlayer!==null && next===lastPlayer){ last=null; lastPlayer=null; log("âœ… ä¸€è½®ç»“æŸï¼Œé‡æ–°é¦–å‡ºã€‚"); }
  }

  async function stepAI(){
    if(hands.some(h=>h.length===0)) return;
    if(turn===0){ render(); return; }
    await new Promise(r=>setTimeout(r,250));
    const h=hands[turn];
    const play=aiPlay(h,last);
    if(!play){
      log(`${turn===1?"AI-1":"AI-2"} è¿‡ç‰Œã€‚`);
    }else{
      remove(h,play.cards);
      last=play; lastPlayer=turn;
      log(`${turn===1?"AI-1":"AI-2"} å‡ºç‰Œï¼š${play.cards.join(' ')}ï¼ˆ${play.type} ä¸»:${play.main}ï¼‰`);
    }
    const next=(turn+1)%3;
    resetIfNeeded(next);
    turn=next;
    render();
    if(turn!==0) stepAI();
  }

  function newGame(){
    logEl.textContent="";
    selected.clear();
    const d=deck();
    hands=[d.slice(0,17),d.slice(17,34),d.slice(34,51)];
    hands[0]=hands[0].concat(d.slice(51)); //åœ°ä¸»
    hands.forEach(sort);
    turn=0; last=null; lastPlayer=null;
    log("ğŸ® æ–°å¼€ä¸€å±€ï¼šä½ æ˜¯åœ°ä¸»ï¼ˆå…ˆæ‰‹ 20 å¼ ï¼‰");
    render();
  }

  function play(){
    if(turn!==0) return;
    const idxs=[...selected].sort((a,b)=>a-b);
    if(!idxs.length){ log("ä½ æ²¡é€‰ç‰Œã€‚"); return; }
    const cards=idxs.map(i=>hands[0][i]);
    const h=classify(cards);
    if(!h){ log("âŒ ä¸æ”¯æŒçš„ç‰Œå‹ï¼ˆåªæ”¯æŒï¼šå•/å¯¹/ä¸‰/ä¸‰å¸¦ä¸€/ä¸‰å¸¦äºŒï¼‰"); return; }
    if(last && !beats(h,last)){ log("âŒ å‹ä¸ä½ä¸Šä¸€æ‰‹ / ç‰Œå‹ä¸ä¸€è‡´"); return; }
    remove(hands[0],cards);
    last=h; lastPlayer=0;
    log(`ä½  å‡ºç‰Œï¼š${cards.join(' ')}ï¼ˆ${h.type} ä¸»:${h.main}ï¼‰`);
    selected.clear();
    turn=1; render(); stepAI();
  }

  function pass(){
    if(turn!==0) return;
    if(!last){ log("âŒ é¦–å‡ºä¸èƒ½è¿‡ç‰Œ"); return; }
    log("ä½  è¿‡ç‰Œã€‚");
    selected.clear();
    const next=1;
    resetIfNeeded(next);
    turn=next;
    render(); stepAI();
  }

  newBtn.onclick=newGame;
  playBtn.onclick=play;
  passBtn.onclick=pass;

  newGame();
})();
</script>
</body>
</html>
